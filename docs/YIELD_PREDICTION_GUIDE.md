# 产量预测实验说明

## 目标

**找到最短的预测时间：用最少的天数（时间步），尽可能准确预测产量**

## 背景

- 数据：36个时间步，每步 = 10天
- 完整周期：36步 = 360天 ≈ 1年
- 问题：能否用前60天（6步）、120天（12步）就准确预测产量？

## 实验设计

### 模型架构

```
输入: 前N步时间序列 [Batch, N, 7变量]
  ↓
双模态编码
  ├─ 视觉模态: 折线图 → CLIP Vision → 特征
  └─ 语言模态: Patches → BERT → 特征
  ↓
特征融合
  ↓
回归层
  ↓
输出: 产量预测 [Batch, 1]
```

**关键特点**：
- ✅ 端到端训练（不做序列补全）
- ✅ 双模态融合（视觉+语言）
- ✅ 支持任意输入长度
- ✅ 直接优化产量预测

### 测试输入长度

| 步数 | 天数 | 阶段 | 说明 |
|-----|------|-----|------|
| 3 | 30天 | 极早期 | 刚播种 |
| 6 | 60天 | 早期 | 幼苗期 |
| 9 | 90天 | 生长期 | 快速生长 |
| 12 | 120天 | 生长期 | 进入关键期 |
| 15 | 150天 | 中期 | 发育中期 |
| 18 | 180天 | 中期 | 半年 |
| 21 | 210天 | 后期 | 接近成熟 |
| 24 | 240天 | 后期 | 成熟期 |
| 27 | 270天 | 晚期 | 准备收获 |
| 30 | 300天 | 晚期 | 收获前 |
| 33 | 330天 | 收获期 | 接近完整 |
| 36 | 360天 | 完整 | 全年数据 |

## 快速开始

### 1. 快速测试（1-2小时）

测试4个关键点，快速验证：

```bash
python quick_yield_test.py
```

**测试点**：
- 60天（6步）
- 120天（12步）
- 180天（18步）
- 300天（30步）

**输出**：
- 每个输入长度的RMSE、MAE、R²
- 可视化曲线
- 最优天数推荐

### 2. 完整实验（6-10小时）

测试12个输入长度，完整分析：

```bash
python train_yield_prediction.py
```

**测试点**：3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36步

**输出**：
- `results/language_only_results.json` - 详细结果
- `results/language_only_analysis.png` - 可视化图表
- `checkpoints/yield_prediction/*.pth` - 训练好的模型

### 3. 查看训练过程

```bash
tensorboard --logdir=logs/yield_prediction
```

## 预期结果

### 假设1：存在"最短有效天数"

**预期曲线**：

```
RMSE ↑
     |
 1.5 |╲
     | ╲___
 1.0 |     ‾‾‾‾‾‾
     |            ‾‾‾
 0.5 +────────────────→ 天数
     30  90  180  270  360
```

**预期**：
- 30-90天：RMSE快速下降（信息增加）
- 120-180天：下降变缓（达到平台期）
- 240天后：几乎不变（边际效益递减）

**最优点预测**：120-180天（12-18步）

### 假设2：边际效益递减

| 天数增加 | RMSE改善 | 性价比 |
|---------|---------|--------|
| 30→60天 | -30% | ⭐⭐⭐⭐⭐ |
| 60→120天 | -20% | ⭐⭐⭐⭐ |
| 120→180天 | -10% | ⭐⭐⭐ |
| 180→240天 | -5% | ⭐⭐ |
| 240→360天 | -2% | ⭐ |

**结论**：120-180天可能是性价比最高的点。

### 假设3：R²达标阈值

**预期**：
- 60天：R² ≈ 0.5-0.6（勉强可用）
- 120天：R² ≈ 0.7-0.8（可接受）
- 180天：R² ≈ 0.85-0.9（良好）
- 360天：R² ≈ 0.9-0.95（优秀）

**建议阈值**：R² > 0.75 即可投入使用

## 模型对比

### 语言模态 vs 双模态

项目包含两种模型：

#### 1. 语言模态（推荐）
```python
model = LanguageOnlyYieldPredictor(
    time_steps=18,
    n_variates=7,
    d_model=256
)
```

**优势**：
- ✅ 训练更快（~50% 时间）
- ✅ 参数更少（~40M vs ~60M）
- ✅ 推理更快
- ✅ 可能性能更好（避免视觉模态噪音）

#### 2. 双模态
```python
model = SimpleYieldPredictor(
    time_steps=18,
    n_variates=7,
    d_model=256,
    use_vision=True,
    use_language=True
)
```

**优势**：
- ✅ 理论上更丰富
- ⚠ 但可能引入噪音

**建议**：先用语言模态，如果效果好就不需要双模态。

## 文件说明

### 核心代码

| 文件 | 说明 |
|------|------|
| `models/simple_yield_predictor.py` | 产量预测模型定义 |
| `data_loader_yield.py` | 数据加载器 |
| `train_yield_prediction.py` | 完整训练脚本 |
| `quick_yield_test.py` | 快速测试脚本 |

### 数据文件

- `extract2019_20251010_165007.csv` - 2019年数据
- `extract2020_20251010_165007.csv` - 2020年数据
- `extract2021_20251010_165007.csv` - 2021年数据
- `extract2022_20251010_165007.csv` - 2022年数据（测试）

训练用前3年，测试用2022年。

### 波段说明

7个选择的波段：
1. **NIR** - 近红外（植被健康）
2. **RVI** - 比值植被指数
3. **SWIR1** - 短波红外（水分）
4. **blue** - 蓝波段
5. **evi** - 增强植被指数
6. **ndvi** - 归一化植被指数（最重要）
7. **red** - 红波段

## 评估指标

### 主要指标

1. **RMSE** (Root Mean Square Error)
   - 预测误差的标准差
   - 越低越好
   - 单位：与产量相同

2. **MAE** (Mean Absolute Error)
   - 平均绝对误差
   - 更直观，对异常值不敏感

3. **R²** (决定系数)
   - 0-1之间，越接近1越好
   - >0.75 可接受，>0.85 良好，>0.9 优秀

4. **MAPE** (Mean Absolute Percentage Error)
   - 平均绝对百分比误差
   - 便于理解（如MAPE=10%表示平均偏差10%）

### 次要指标

- 训练时间
- 模型参数量
- 推理速度
- 内存占用

## 应用场景

### 场景1：早期预警（60-120天）

**目标**：播种后2-4个月预测产量

**价值**：
- 提前8-10个月知道产量
- 调整种植策略
- 市场规划

**可接受精度**：R² > 0.6

### 场景2：中期预测（150-180天）

**目标**：生长期中期预测产量

**价值**：
- 提前6个月确定产量
- 优化资源配置
- 库存管理

**可接受精度**：R² > 0.75

### 场景3：准确预测（240天+）

**目标**：收获前精确预测

**价值**：
- 制定收获计划
- 销售定价
- 物流安排

**可接受精度**：R² > 0.85

## 实验流程

```
开始
  ├─ 加载数据（2019-2021训练，2022测试）
  ├─ 对每个输入长度:
  │   ├─ 创建数据加载器
  │   ├─ 初始化模型
  │   ├─ 训练模型（50 epochs，早停）
  │   ├─ 评估模型
  │   └─ 保存结果
  ├─ 可视化分析
  │   ├─ RMSE vs 天数曲线
  │   ├─ R² vs 天数曲线
  │   └─ 边际效益分析
  └─ 输出最优配置
```

## 结果解读

### 场景1：最优点在120天

**结论**：
- ✅ 120天（12步）即可达到可接受精度
- ✅ 提前8个月预测
- ✅ 性价比最高

**推荐**：
- 实际应用使用120天模型
- 可在150天时更新预测

### 场景2：最优点在180天

**结论**：
- ⚠ 需要半年数据才能准确预测
- ⚠ 提前6个月，但时间较紧
- ⚠ 早期预测不够准确

**推荐**：
- 120天用于早期预警（粗略）
- 180天用于正式预测（准确）

### 场景3：持续改善到360天

**结论**：
- ❌ 没有明显平台期
- ❌ 越晚越准，但失去预测意义
- ❌ 模型可能过度依赖后期数据

**问题诊断**：
- 检查是否有数据泄漏
- 检查后期特征是否过强
- 考虑增加正则化

## 常见问题

### Q1：训练太慢怎么办？

```bash
# 使用语言模态（更快）
python train_yield_prediction.py --model language_only

# 减少epochs
python train_yield_prediction.py --epochs 30

# 减少测试点
python quick_yield_test.py
```

### Q2：内存不足？

```bash
# 减小batch size
# 修改train_yield_prediction.py中的batch_size=32改为16
```

### Q3：如何使用训练好的模型？

```python
import torch
from models.simple_yield_predictor import LanguageOnlyYieldPredictor

# 加载模型
model = LanguageOnlyYieldPredictor(time_steps=18, n_variates=7, d_model=256)
model.load_state_dict(torch.load('checkpoints/yield_prediction/language_only_steps18.pth'))
model.eval()

# 预测
x = torch.randn(1, 18, 7)  # 180天的数据
yield_pred = model(x)
print(f"预测产量: {yield_pred.item():.2f}")
```

## 下一步扩展

### 扩展1：置信区间

添加不确定性估计：
```python
# 使用Dropout作为贝叶斯近似
predictions = []
for _ in range(100):
    model.train()  # 启用dropout
    pred = model(x)
    predictions.append(pred)

mean = np.mean(predictions)
std = np.std(predictions)
CI_95 = [mean - 1.96*std, mean + 1.96*std]
```

### 扩展2：多任务学习

同时预测产量和质量：
```python
self.regressor_yield = nn.Linear(d_model, 1)
self.regressor_quality = nn.Linear(d_model, 1)
```

### 扩展3：注意力可视化

可视化哪些时间步最重要：
```python
attention_weights = model.get_attention_weights(x)
# 绘制热力图
```

## 总结

这个实验将回答：

1. ✅ **最短需要多少天？** → 找到最优天数
2. ✅ **性价比如何变化？** → 边际效益分析
3. ✅ **何时达到可用精度？** → R²阈值分析
4. ✅ **双模态有必要吗？** → 对比单模态

**预期收获**：
- 科学的早期预测方案
- 不同阶段的预测精度
- 成本-收益权衡
- 最优输入长度推荐

开始实验吧！🚀

```bash
# 快速测试
python quick_yield_test.py

# 完整实验
python train_yield_prediction.py
```

