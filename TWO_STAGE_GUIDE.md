# 两阶段预测完整指南

## 项目需求

**最终目标**: 输入2025年1-5月的波段值 → 预测2025年的产量

## 为什么需要两个模型？

### 问题分解

这个任务实际上包含两个子问题：

1. **时间序列补全问题**: 1-5月波段值 → 6-12月波段值
2. **产量预测问题**: 完整全年波段值 → 年度产量

单个模型很难同时处理这两个不同性质的任务，因此我们采用**两阶段方法**。

---

## 两个模型详解

### 📊 模型1: TimesCLIP（时间序列补全）

**文件**: `models/timesclip.py`

**作用**: 波段值时间序列预测（补全缺失的时间段）

**输入**: 
- 形状: `[Batch, 18, 7]`
- 含义: 1-5月的7个波段数据（18个时间步，每步10天）

**输出**:
- 形状: `[Batch, 7, 18]`
- 含义: 6-12月的7个波段预测值（18个时间步）

**训练数据**: 
- 使用2022年历史数据
- 训练模式: 用前18步预测后18步

**特点**:
- 双模态学习（视觉+语言）
- 对比学习对齐特征
- 适合时间序列预测任务

---

### 🌾 模型2: YieldPredictor（产量预测）

**文件**: `models/yield_predictor.py`

**作用**: 根据全年波段特征预测产量

**输入**:
- 形状: `[Batch, 36, 7]`
- 含义: 完整全年的7个波段数据（36个时间步）

**输出**:
- 形状: `[Batch, 1]`
- 含义: 年度产量预测值

**训练数据**:
- 使用2022年历史数据
- X: 完整36步波段值
- Y: y2022产量标签

**特点**:
- Transformer编码器
- 时序特征提取
- 回归任务

---

## 完整工作流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     2025年产量预测流程                          │
└─────────────────────────────────────────────────────────────────┘

输入: 2025年1-5月波段观测数据
     [18, 7] - 18个时间步 × 7个波段
          │
          ├─ NIR_00, NIR_01, ..., NIR_17
          ├─ RVI_00, RVI_01, ..., RVI_17
          ├─ SWIR1_00, SWIR1_01, ..., SWIR1_17
          ├─ blue_00, blue_01, ..., blue_17
          ├─ evi_00, evi_01, ..., evi_17
          ├─ ndvi_00, ndvi_01, ..., ndvi_17
          └─ red_00, red_01, ..., red_17
          │
          ↓
┌─────────────────────────────────────────┐
│   阶段1: TimesCLIP（波段值补全）       │
│   ------------------------------------ │
│   输入: [18, 7] 1-5月波段值            │
│   输出: [18, 7] 6-12月波段值（预测）   │
└─────────────────────────────────────────┘
          │
          ↓
    拼接成完整全年数据
     [36, 7] = [18, 7] + [18, 7]
          │
          ↓
┌─────────────────────────────────────────┐
│   阶段2: YieldPredictor（产量预测）    │
│   ------------------------------------ │
│   输入: [36, 7] 全年波段值             │
│   输出: [1] 产量预测值                 │
└─────────────────────────────────────────┘
          │
          ↓
     最终结果
  2025年产量: X.XX 吨/亩（或其他单位）
```

---

## 训练流程

### 第一步：训练两个模型

运行两阶段训练脚本：

```bash
python train_two_stage.py
```

这会依次训练：

1. **阶段1**: TimesCLIP时间序列补全模型
   - 训练数据: 2022年波段数据
   - 任务: 前18步 → 后18步
   - 保存为: `checkpoints/stage1_timeseries_best.pth`
   - 训练轮数: 50 epochs
   - 监控: TensorBoard `logs/stage1`

2. **阶段2**: YieldPredictor产量预测模型
   - 训练数据: 2022年完整36步 + y2022标签
   - 任务: 36步波段值 → 产量
   - 保存为: `checkpoints/stage2_yield_best.pth`
   - 训练轮数: 100 epochs
   - 监控: TensorBoard `logs/stage2`

### 监控训练进度

```bash
# 阶段1监控
tensorboard --logdir=logs/stage1 --port=6006

# 阶段2监控
tensorboard --logdir=logs/stage2 --port=6007
```

---

## 预测2025年产量

### 使用预测脚本

```bash
python predict_2025.py
```

### 自定义预测

```python
import numpy as np
from predict_2025 import predict_2025_yield

# 准备2025年1-5月数据
# 形状: [18, 7] - 18个时间步，7个波段
input_2025 = np.array([
    # 时间步0: [NIR, RVI, SWIR1, blue, evi, ndvi, red]
    [5000, 8000, 3500, 1500, 5400, 0.65, 1800],
    [5100, 8100, 3600, 1520, 5450, 0.66, 1820],
    # ... 共18个时间步
])

# 进行预测
result = predict_2025_yield(
    input_2025_data=input_2025,
    band_names=['NIR', 'RVI', 'SWIR1', 'blue', 'evi', 'ndvi', 'red'],
    device='cuda',
    visualize=True
)

print(f"预测产量: {result['yield_prediction']:.2f}")
print(f"完整全年数据形状: {result['full_year_data'].shape}")
```

---

## 文件说明

### 训练相关

| 文件 | 说明 |
|------|------|
| `train_two_stage.py` | 两阶段训练主脚本 |
| `data_loader_with_yield.py` | 支持两种模式的数据加载器 |
| `models/timesclip.py` | TimesCLIP模型（阶段1） |
| `models/yield_predictor.py` | YieldPredictor模型（阶段2） |

### 预测相关

| 文件 | 说明 |
|------|------|
| `predict_2025.py` | 2025年产量预测脚本 |
| `checkpoints/stage1_timeseries_best.pth` | 阶段1最佳模型 |
| `checkpoints/stage2_yield_best.pth` | 阶段2最佳模型 |

### 输出结果

| 文件/目录 | 说明 |
|-----------|------|
| `2025_prediction.png` | 预测波段值可视化 |
| `logs/stage1/` | 阶段1训练日志 |
| `logs/stage2/` | 阶段2训练日志 |

---

## 数据要求

### 训练数据（2022年历史数据）

**文件**: `extract2022_20251010_165007.csv`

**格式**:
- 每行一个样本
- 14个波段 × 36个时间步 = 504列波段数据
- y2019, y2020, y2021, y2022 产量标签

**使用**:
- 波段列（如NIR_00到NIR_35）用于训练时间序列模型
- y2022列用于训练产量预测模型

### 预测数据（2025年）

**要求**:
- 形状: `[18, 7]`
- 内容: 2025年1-5月的遥感观测数据
- 波段顺序: NIR, RVI, SWIR1, blue, evi, ndvi, red
- 来源: 卫星遥感数据

---

## 性能预期

### 阶段1（时间序列补全）

- **MSE损失**: < 500000（取决于数据尺度）
- **对比学习损失**: < 2.0
- **预测趋势**: 应能跟随季节性变化

### 阶段2（产量预测）

- **MAE**: 取决于产量单位和数据质量
- **相关性**: 预测值与真实值应有较强相关性
- **泛化能力**: 在测试集上表现稳定

---

## 常见问题

### Q1: 为什么不用一个端到端的模型？

**答**: 
- 任务性质不同：时间序列预测 vs 回归预测
- 训练稳定性：分阶段训练更容易收敛
- 可解释性：可以分别评估每个阶段的效果
- 灵活性：可以单独改进某个阶段

### Q2: 如果我只有3个月的数据怎么办？

**答**: 调整`lookback`参数：
- 3个月 ≈ 9个时间步
- 修改训练脚本中的`lookback=9`
- 重新训练模型

### Q3: 可以预测其他年份吗？

**答**: 可以！只需：
- 提供对应年份1-5月的波段数据
- 使用相同的预测脚本
- 模型会输出该年份的产量预测

### Q4: 如何提高预测精度？

**答**: 
1. 增加训练数据（多年份数据）
2. 使用更多波段（全部14个）
3. 调整模型超参数（d_model, n_layers等）
4. 尝试数据增强技术
5. 集成多个模型的预测结果

---

## 下一步优化

1. ✨ 添加不确定性估计（置信区间）
2. ✨ 支持多年份产量预测
3. ✨ 添加特征重要性分析
4. ✨ 实现在线学习（增量更新）
5. ✨ 部署为Web API服务

---

## 总结

| 方面 | 说明 |
|------|------|
| **问题** | 预测2025年产量 |
| **输入** | 2025年1-5月波段数据 |
| **方法** | 两阶段预测 |
| **模型1** | TimesCLIP（时间序列补全） |
| **模型2** | YieldPredictor（产量预测） |
| **输出** | 2025年产量预测值 |
| **状态** | ✅ 完全实现，可直接使用 |

现在可以运行 `python train_two_stage.py` 开始训练！

